# ğŸ§  æ™ºèƒ½å¢é‡æ›´æ–°æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒæ€æƒ³

é€šè¿‡æ™ºèƒ½åˆ†ææ•°æ®ç¼ºå¤±æƒ…å†µï¼Œå®ç°ç²¾å‡†çš„å¢é‡æ›´æ–°ï¼Œè€Œä¸æ˜¯ç®€å•çš„æ—¶é—´èŒƒå›´æ›´æ–°ã€‚

## ğŸ“Š æ™ºèƒ½å¢é‡æ›´æ–°ç­–ç•¥

### 1. æ•°æ®å®Œæ•´æ€§æ£€æµ‹

```python
# æ•°æ®å®Œæ•´æ€§æ£€æµ‹é…ç½®
DATA_INTEGRITY_CONFIG = {
    'daily_basic': {
        'expected_stock_count': 5000,  # é¢„æœŸè‚¡ç¥¨æ•°é‡
        'missing_threshold': 0.05,     # ç¼ºå¤±ç‡é˜ˆå€¼5%
        'check_days': 30,              # æ£€æŸ¥æœ€è¿‘30ä¸ªäº¤æ˜“æ—¥
        'full_update_threshold': 0.20   # è¶…è¿‡20%ç¼ºå¤±åˆ™å…¨é‡æ›´æ–°è¯¥æ—¥
    },
    'index_daily': {
        'expected_index_count': 300,
        'missing_threshold': 0.03,
        'check_days': 30,
        'full_update_threshold': 0.15
    }
}
```

### 2. ç¼ºå¤±æ•°æ®æ£€æµ‹ç®—æ³•

```python
def detect_missing_data(table_name, check_days=30):
    """
    æ£€æµ‹ç¼ºå¤±æ•°æ®
    è¿”å›: {
        'missing_dates': ['20241201', '20241202'],
        'partial_dates': {
            '20241203': {'missing_count': 250, 'total_expected': 5000}
        }
    }
    """
    
    # 1. è·å–æœ€è¿‘Nä¸ªäº¤æ˜“æ—¥
    trade_dates = get_recent_trade_dates(check_days)
    
    # 2. è·å–æ´»è·ƒè‚¡ç¥¨åˆ—è¡¨
    active_stocks = get_active_stocks()
    expected_count = len(active_stocks)
    
    missing_info = {
        'missing_dates': [],      # å®Œå…¨ç¼ºå¤±çš„æ—¥æœŸ
        'partial_dates': {},      # éƒ¨åˆ†ç¼ºå¤±çš„æ—¥æœŸ
        'complete_dates': []      # æ•°æ®å®Œæ•´çš„æ—¥æœŸ
    }
    
    for trade_date in trade_dates:
        # æ£€æŸ¥è¯¥æ—¥æœŸçš„æ•°æ®å®Œæ•´æ€§
        actual_count = count_records_for_date(table_name, trade_date)
        
        if actual_count == 0:
            # å®Œå…¨ç¼ºå¤±
            missing_info['missing_dates'].append(trade_date)
        elif actual_count < expected_count:
            # éƒ¨åˆ†ç¼ºå¤±
            missing_count = expected_count - actual_count
            missing_rate = missing_count / expected_count
            
            config = DATA_INTEGRITY_CONFIG[table_name]
            
            if missing_rate > config['missing_threshold']:
                missing_info['partial_dates'][trade_date] = {
                    'missing_count': missing_count,
                    'total_expected': expected_count,
                    'missing_rate': missing_rate,
                    'need_full_update': missing_rate > config['full_update_threshold']
                }
        else:
            # æ•°æ®å®Œæ•´
            missing_info['complete_dates'].append(trade_date)
    
    return missing_info
```

### 3. æ™ºèƒ½æ›´æ–°å†³ç­–

```python
def create_update_plan(missing_info, table_name):
    """
    æ ¹æ®ç¼ºå¤±æƒ…å†µåˆ¶å®šæ›´æ–°è®¡åˆ’
    """
    update_plan = {
        'full_update_dates': [],      # éœ€è¦å…¨é‡æ›´æ–°çš„æ—¥æœŸ
        'partial_update_dates': [],   # éœ€è¦éƒ¨åˆ†æ›´æ–°çš„æ—¥æœŸ
        'missing_stocks_by_date': {}  # æ¯ä¸ªæ—¥æœŸç¼ºå¤±çš„å…·ä½“è‚¡ç¥¨
    }
    
    # 1. å¤„ç†å®Œå…¨ç¼ºå¤±çš„æ—¥æœŸ
    update_plan['full_update_dates'].extend(missing_info['missing_dates'])
    
    # 2. å¤„ç†éƒ¨åˆ†ç¼ºå¤±çš„æ—¥æœŸ
    for date, info in missing_info['partial_dates'].items():
        if info['need_full_update']:
            # ç¼ºå¤±ç‡è¿‡é«˜ï¼Œå…¨é‡æ›´æ–°è¯¥æ—¥
            update_plan['full_update_dates'].append(date)
        else:
            # ç¼ºå¤±ç‡è¾ƒä½ï¼Œåªæ›´æ–°ç¼ºå¤±çš„è‚¡ç¥¨
            update_plan['partial_update_dates'].append(date)
            missing_stocks = find_missing_stocks_for_date(table_name, date)
            update_plan['missing_stocks_by_date'][date] = missing_stocks
    
    return update_plan
```

### 4. ç¼ºå¤±è‚¡ç¥¨è¯†åˆ«

```python
def find_missing_stocks_for_date(table_name, trade_date):
    """
    æ‰¾å‡ºæŒ‡å®šæ—¥æœŸç¼ºå¤±æ•°æ®çš„è‚¡ç¥¨
    """
    # è·å–æ‰€æœ‰æ´»è·ƒè‚¡ç¥¨
    all_stocks = get_active_stocks_for_date(trade_date)
    
    # è·å–å·²æœ‰æ•°æ®çš„è‚¡ç¥¨
    existing_stocks = get_existing_stocks_for_date(table_name, trade_date)
    
    # è®¡ç®—ç¼ºå¤±çš„è‚¡ç¥¨
    missing_stocks = set(all_stocks) - set(existing_stocks)
    
    return list(missing_stocks)

def get_active_stocks_for_date(trade_date):
    """
    è·å–æŒ‡å®šæ—¥æœŸçš„æ´»è·ƒè‚¡ç¥¨åˆ—è¡¨ï¼ˆæ’é™¤åœç‰Œã€é€€å¸‚ç­‰ï¼‰
    """
    conn = sqlite3.connect("database/stock_data.db")
    cursor = conn.cursor()
    
    # æŸ¥è¯¢åœ¨è¯¥æ—¥æœŸå‰ä¸Šå¸‚ä¸”æœªé€€å¸‚çš„è‚¡ç¥¨
    cursor.execute("""
        SELECT ts_code FROM stock_basic 
        WHERE list_date <= ? 
        AND (delist_date IS NULL OR delist_date > ?)
    """, (trade_date, trade_date))
    
    stocks = [row[0] for row in cursor.fetchall()]
    conn.close()
    
    return stocks
```

## ğŸ”„ å¢é‡æ›´æ–°æ‰§è¡Œæµç¨‹

### 1. æ•°æ®å®Œæ•´æ€§åˆ†æè¡¨

```sql
-- æ•°æ®å®Œæ•´æ€§åˆ†æè¡¨
CREATE TABLE data_integrity_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    table_name TEXT,
    trade_date TEXT,
    expected_count INTEGER,
    actual_count INTEGER,
    missing_count INTEGER,
    missing_rate REAL,
    check_time TEXT,
    status TEXT,  -- 'complete', 'partial', 'missing'
    UNIQUE(table_name, trade_date, check_time)
);

-- æ›´æ–°ä»»åŠ¡è¡¨
CREATE TABLE update_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_type TEXT,  -- 'full_date', 'partial_date', 'missing_stocks'
    table_name TEXT,
    trade_date TEXT,
    target_stocks TEXT,  -- JSONæ ¼å¼çš„è‚¡ç¥¨åˆ—è¡¨
    status TEXT,     -- 'pending', 'running', 'completed', 'failed'
    created_time TEXT,
    start_time TEXT,
    end_time TEXT,
    error_msg TEXT
);
```

### 2. æ™ºèƒ½æ›´æ–°ä¸»æµç¨‹

```python
class SmartIncrementalUpdater:
    def __init__(self):
        self.config = DATA_INTEGRITY_CONFIG
        
    def run_smart_update(self, tables=['daily_basic', 'index_daily']):
        """
        æ‰§è¡Œæ™ºèƒ½å¢é‡æ›´æ–°
        """
        update_summary = {
            'total_tasks': 0,
            'completed_tasks': 0,
            'failed_tasks': 0,
            'updated_records': 0
        }
        
        for table_name in tables:
            print(f"ğŸ” åˆ†æ {table_name} æ•°æ®å®Œæ•´æ€§...")
            
            # 1. æ£€æµ‹ç¼ºå¤±æ•°æ®
            missing_info = detect_missing_data(table_name)
            
            # 2. åˆ¶å®šæ›´æ–°è®¡åˆ’
            update_plan = create_update_plan(missing_info, table_name)
            
            # 3. è®°å½•åˆ†æç»“æœ
            self.log_integrity_analysis(table_name, missing_info)
            
            # 4. æ‰§è¡Œæ›´æ–°ä»»åŠ¡
            task_results = self.execute_update_plan(table_name, update_plan)
            
            # 5. æ›´æ–°ç»Ÿè®¡
            update_summary['total_tasks'] += task_results['total']
            update_summary['completed_tasks'] += task_results['completed']
            update_summary['failed_tasks'] += task_results['failed']
            update_summary['updated_records'] += task_results['records']
        
        return update_summary
    
    def execute_update_plan(self, table_name, update_plan):
        """
        æ‰§è¡Œæ›´æ–°è®¡åˆ’
        """
        results = {'total': 0, 'completed': 0, 'failed': 0, 'records': 0}
        
        # 1. å¤„ç†å…¨é‡æ›´æ–°æ—¥æœŸ
        for date in update_plan['full_update_dates']:
            task_id = self.create_update_task('full_date', table_name, date)
            success, records = self.update_full_date_data(table_name, date)
            
            results['total'] += 1
            if success:
                results['completed'] += 1
                results['records'] += records
                self.update_task_status(task_id, 'completed')
            else:
                results['failed'] += 1
                self.update_task_status(task_id, 'failed')
        
        # 2. å¤„ç†éƒ¨åˆ†æ›´æ–°æ—¥æœŸ
        for date in update_plan['partial_update_dates']:
            missing_stocks = update_plan['missing_stocks_by_date'][date]
            task_id = self.create_update_task('partial_date', table_name, date, missing_stocks)
            success, records = self.update_partial_date_data(table_name, date, missing_stocks)
            
            results['total'] += 1
            if success:
                results['completed'] += 1
                results['records'] += records
                self.update_task_status(task_id, 'completed')
            else:
                results['failed'] += 1
                self.update_task_status(task_id, 'failed')
        
        return results
```

### 3. å…·ä½“æ›´æ–°å®ç°

```python
def update_full_date_data(self, table_name, trade_date):
    """
    å…¨é‡æ›´æ–°æŒ‡å®šæ—¥æœŸçš„æ•°æ®
    """
    try:
        if table_name == 'daily_basic':
            # è·å–è¯¥æ—¥æ‰€æœ‰è‚¡ç¥¨çš„è¡Œæƒ…æ•°æ®
            df = pro.daily(trade_date=trade_date)
        elif table_name == 'index_daily':
            # è·å–è¯¥æ—¥æ‰€æœ‰æŒ‡æ•°çš„è¡Œæƒ…æ•°æ®
            df = pro.index_daily(trade_date=trade_date)
        
        if df.empty:
            return False, 0
        
        # åˆ é™¤è¯¥æ—¥æœŸçš„æ—§æ•°æ®
        self.delete_date_data(table_name, trade_date)
        
        # æ’å…¥æ–°æ•°æ®
        records_count = self.insert_data(table_name, df)
        
        return True, records_count
        
    except Exception as e:
        print(f"âŒ å…¨é‡æ›´æ–°å¤±è´¥ {table_name} {trade_date}: {e}")
        return False, 0

def update_partial_date_data(self, table_name, trade_date, missing_stocks):
    """
    éƒ¨åˆ†æ›´æ–°æŒ‡å®šæ—¥æœŸçš„ç¼ºå¤±è‚¡ç¥¨æ•°æ®
    """
    try:
        updated_records = 0
        
        # åˆ†æ‰¹å¤„ç†ç¼ºå¤±çš„è‚¡ç¥¨
        batch_size = 50
        for i in range(0, len(missing_stocks), batch_size):
            batch_stocks = missing_stocks[i:i+batch_size]
            
            if table_name == 'daily_basic':
                # è·å–æŒ‡å®šè‚¡ç¥¨çš„è¡Œæƒ…æ•°æ®
                for ts_code in batch_stocks:
                    df = pro.daily(ts_code=ts_code, trade_date=trade_date)
                    if not df.empty:
                        self.insert_data(table_name, df)
                        updated_records += len(df)
            
        return True, updated_records
        
    except Exception as e:
        print(f"âŒ éƒ¨åˆ†æ›´æ–°å¤±è´¥ {table_name} {trade_date}: {e}")
        return False, 0
```

## ğŸ“Š ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–

```python
# ç¼“å­˜æœºåˆ¶
CACHE_CONFIG = {
    'active_stocks': {
        'ttl': 3600,  # 1å°æ—¶ç¼“å­˜
        'key': 'active_stocks_list'
    },
    'trade_dates': {
        'ttl': 86400,  # 24å°æ—¶ç¼“å­˜
        'key': 'recent_trade_dates'
    }
}

# å¹¶å‘å¤„ç†
CONCURRENT_CONFIG = {
    'max_workers': 5,           # æœ€å¤§å¹¶å‘æ•°
    'batch_size': 50,           # æ¯æ‰¹å¤„ç†è‚¡ç¥¨æ•°
    'api_rate_limit': 200       # APIè°ƒç”¨é¢‘ç‡é™åˆ¶
}
```

### 2. ç›‘æ§å’Œå‘Šè­¦

```python
# æ•°æ®è´¨é‡ç›‘æ§
QUALITY_MONITORS = {
    'missing_rate_alert': 0.10,     # ç¼ºå¤±ç‡è¶…è¿‡10%å‘Šè­¦
    'update_failure_alert': 3,      # è¿ç»­3æ¬¡æ›´æ–°å¤±è´¥å‘Šè­¦
    'data_delay_alert': 2           # æ•°æ®å»¶è¿Ÿè¶…è¿‡2å¤©å‘Šè­¦
}

def check_data_quality():
    """
    æ•°æ®è´¨é‡æ£€æŸ¥
    """
    alerts = []
    
    for table_name in ['daily_basic', 'index_daily']:
        # æ£€æŸ¥æœ€è¿‘æ•°æ®çš„å®Œæ•´æ€§
        latest_missing = detect_missing_data(table_name, check_days=5)
        
        if latest_missing['missing_dates']:
            alerts.append(f"âš ï¸ {table_name} å­˜åœ¨å®Œå…¨ç¼ºå¤±çš„äº¤æ˜“æ—¥: {latest_missing['missing_dates']}")
        
        for date, info in latest_missing['partial_dates'].items():
            if info['missing_rate'] > QUALITY_MONITORS['missing_rate_alert']:
                alerts.append(f"âš ï¸ {table_name} {date} ç¼ºå¤±ç‡è¿‡é«˜: {info['missing_rate']:.2%}")
    
    return alerts
```

### 3. ç”¨æˆ·ç•Œé¢å¢å¼º

```python
# GUIä¸­çš„æ™ºèƒ½æ›´æ–°çŠ¶æ€æ˜¾ç¤º
class SmartUpdateStatusWidget:
    def show_analysis_result(self, missing_info):
        """
        æ˜¾ç¤ºæ•°æ®åˆ†æç»“æœ
        """
        status_text = []
        
        if missing_info['missing_dates']:
            status_text.append(f"ğŸ”´ å®Œå…¨ç¼ºå¤±: {len(missing_info['missing_dates'])} ä¸ªäº¤æ˜“æ—¥")
        
        if missing_info['partial_dates']:
            partial_count = len(missing_info['partial_dates'])
            status_text.append(f"ğŸŸ¡ éƒ¨åˆ†ç¼ºå¤±: {partial_count} ä¸ªäº¤æ˜“æ—¥")
        
        if missing_info['complete_dates']:
            complete_count = len(missing_info['complete_dates'])
            status_text.append(f"ğŸŸ¢ æ•°æ®å®Œæ•´: {complete_count} ä¸ªäº¤æ˜“æ—¥")
        
        return "\n".join(status_text)
```

## ğŸ¯ å®æ–½ä¼˜åŠ¿

### 1. æ•ˆç‡æå‡
- **ç²¾å‡†æ›´æ–°**: åªæ›´æ–°çœŸæ­£ç¼ºå¤±çš„æ•°æ®
- **APIèŠ‚çº¦**: é¿å…é‡å¤è·å–å·²æœ‰æ•°æ®
- **æ—¶é—´èŠ‚çœ**: æ™ºèƒ½è·³è¿‡å®Œæ•´æ•°æ®

### 2. æ•°æ®è´¨é‡
- **å®Œæ•´æ€§ä¿è¯**: ç¡®ä¿æ•°æ®æ— é—æ¼
- **ä¸€è‡´æ€§æ£€æŸ¥**: è‡ªåŠ¨å‘ç°æ•°æ®å¼‚å¸¸
- **è´¨é‡ç›‘æ§**: å®æ—¶ç›‘æ§æ•°æ®çŠ¶æ€

### 3. ç”¨æˆ·ä½“éªŒ
- **é€æ˜è¿›åº¦**: æ¸…æ™°æ˜¾ç¤ºæ›´æ–°å†…å®¹
- **æ™ºèƒ½å†³ç­–**: è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ›´æ–°ç­–ç•¥
- **é”™è¯¯æ¢å¤**: æ”¯æŒå¤±è´¥ä»»åŠ¡é‡è¯•

è¿™ä¸ªæ™ºèƒ½å¢é‡æ›´æ–°æ–¹æ¡ˆæ¯”ç®€å•çš„30å¤©æ›´æ–°è¦é«˜æ•ˆå¾—å¤šï¼Œæ‚¨è§‰å¾—è¿™ä¸ªè®¾è®¡å¦‚ä½•ï¼Ÿ