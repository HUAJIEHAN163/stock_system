# 数据库字段覆盖问题

**问题发现日期**: 2024年12月  
**问题类型**: 数据完整性  
**优先级**: 高  
**状态**: 待解决

## 🔍 问题描述

通过数据库字段覆盖检查发现，多只股票多日查询API的字段覆盖率不完整，部分重要字段缺失。

## 📊 具体问题

### 1. 字段覆盖率统计
- **完全覆盖**: 3/7个API (42.9%)
- **部分覆盖**: 4/7个API (57.1%)
- **总体覆盖率**: 需要提升

### 2. 各API字段缺失情况

#### stock_basic (股票列表) - 覆盖率52.9%
**缺失字段**:
- `fullname` - 股票全称
- `enname` - 英文全称  
- `cnspell` - 拼音缩写
- `exchange` - 交易所代码
- `curr_type` - 交易货币
- `list_status` - 上市状态
- `act_name` - 实控人名称
- `act_ent_type` - 实控人企业性质

#### daily_basic (每日指标) - 覆盖率38.9%
**缺失字段**:
- `turnover_rate_f` - 换手率（自由流通股）
- `pe_ttm` - 市盈率（TTM）
- `ps` - 市销率
- `ps_ttm` - 市销率（TTM）
- `dv_ratio` - 股息率
- `dv_ttm` - 股息率（TTM）
- `total_share` - 总股本
- `float_share` - 流通股本
- `free_share` - 自由流通股本
- `total_mv` - 总市值
- `circ_mv` - 流通市值

#### stock_company (公司信息) - 覆盖率72.2%
**缺失字段**:
- `com_id` - 统一社会信用代码
- `exchange` - 交易所代码
- `introduction` - 公司介绍
- `office` - 办公室
- `business_scope` - 经营范围

#### trade_calendar (交易日历) - 覆盖率75.0%
**缺失字段**:
- `exchange` - 交易所代码

## 🎯 解决方案

### 方案1: 数据库表结构扩展
1. **修改现有表结构**，添加缺失字段
2. **重新初始化数据**，获取完整字段数据
3. **更新数据管理器**，支持新字段

### 方案2: 创建补充表
1. **保持现有表结构**不变
2. **创建补充表**存储缺失字段
3. **通过关联查询**获取完整数据

### 方案3: 分阶段补充
1. **优先补充核心字段**（如pe_ttm, total_mv等）
2. **后续补充辅助字段**（如fullname, enname等）
3. **逐步完善数据结构**

## 📋 实施计划

### 阶段1: 核心字段补充 (优先级: 高)
- [ ] 扩展daily_basic表，添加pe_ttm, total_mv, circ_mv等核心指标
- [ ] 扩展stock_basic表，添加list_status, exchange等关键字段
- [ ] 重新获取这些字段的数据

### 阶段2: 辅助字段补充 (优先级: 中)
- [ ] 补充stock_company表的详细信息字段
- [ ] 补充stock_basic表的描述性字段
- [ ] 完善trade_calendar表

### 阶段3: 数据验证 (优先级: 高)
- [ ] 验证新字段数据完整性
- [ ] 检查数据质量和一致性
- [ ] 更新相关查询和分析功能

## 🔧 技术实施

### 1. 数据库迁移脚本
```sql
-- 扩展daily_basic表
ALTER TABLE daily_basic ADD COLUMN pe_ttm REAL;
ALTER TABLE daily_basic ADD COLUMN total_mv REAL;
ALTER TABLE daily_basic ADD COLUMN circ_mv REAL;
-- ... 其他字段

-- 扩展stock_basic表  
ALTER TABLE stock_basic ADD COLUMN list_status TEXT;
ALTER TABLE stock_basic ADD COLUMN exchange TEXT;
-- ... 其他字段
```

### 2. 数据重新获取
- 修改API调用，指定完整字段列表
- 批量更新现有记录的缺失字段
- 验证数据完整性

### 3. 代码更新
- 更新DatabaseManager类的表结构定义
- 修改数据初始化脚本
- 更新相关查询和分析代码

## ⚠️ 风险评估

### 数据风险
- **数据丢失**: 表结构修改可能导致数据丢失
- **数据不一致**: 新旧数据可能存在不一致

### 技术风险  
- **API限制**: 重新获取大量数据可能触发API限制
- **性能影响**: 表结构变更可能影响查询性能

### 业务风险
- **功能中断**: 数据库变更可能影响现有功能
- **时间成本**: 数据重新获取需要较长时间

## 📈 预期收益

### 数据完整性提升
- 字段覆盖率从42.9%提升到90%+
- 支持更丰富的数据分析功能

### 功能增强
- 支持更精确的股票筛选
- 提供更全面的基本面分析
- 增强数据可视化能力

## 📅 时间计划

- **第1周**: 设计数据库迁移方案
- **第2周**: 实施核心字段扩展
- **第3周**: 重新获取数据并验证
- **第4周**: 测试和优化

## 👥 责任人

- **技术负责人**: 开发团队
- **数据负责人**: 数据分析团队  
- **测试负责人**: 质量保证团队

---

**创建时间**: 2024年12月  
**最后更新**: 2024年12月  
**关联文档**: [API接口分类详表](../数据调查/数据准备/01_Tushare_API接口分类详表.md)