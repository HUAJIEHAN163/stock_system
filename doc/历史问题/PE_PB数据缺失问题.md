# PE/PB数据缺失问题

**问题发现日期**: 2024年12月  
**问题类型**: 数据质量  
**优先级**: 高  
**状态**: 待解决

## 🔍 问题描述

在数据质量检查中发现，daily_basic表中的PE和PB字段全部为空值，影响基本面分析功能。

## 📊 问题详情

### 数据统计
- **表名**: daily_basic
- **总记录数**: 655,449条
- **PE字段空值**: 655,449条 (100%)
- **PB字段空值**: 655,449条 (100%)
- **影响范围**: 所有股票的所有交易日

### 问题影响
1. **无法进行估值分析**: PE/PB是核心估值指标
2. **筛选功能受限**: 无法按估值指标筛选股票
3. **分析报告不完整**: 缺少重要的基本面数据
4. **用户体验差**: 关键指标显示为空

## 🔍 原因分析

### 可能原因1: API字段映射错误
- daily_basic表合并了daily和daily_basic两个API的数据
- PE/PB字段可能来自daily_basic API，但未正确获取

### 可能原因2: 数据获取逻辑问题
- 初始化时可能只获取了daily API的字段
- 未调用daily_basic API获取PE/PB等指标

### 可能原因3: 字段名称不匹配
- API返回的字段名与数据库字段名不一致
- 数据插入时字段映射错误

## 🎯 解决方案

### 方案1: 重新获取daily_basic数据 (推荐)
1. **调用daily_basic API**获取PE/PB等指标数据
2. **更新现有记录**的PE/PB字段
3. **验证数据完整性**

### 方案2: 分离daily和daily_basic表
1. **创建独立的daily_basic表**
2. **重新获取daily_basic API数据**
3. **通过关联查询**获取完整数据

### 方案3: 计算PE/PB值
1. **获取财务数据**（净利润、净资产）
2. **结合市值数据**计算PE/PB
3. **定期更新计算结果**

## 📋 实施计划

### 阶段1: 问题确认 (1天)
- [ ] 检查API文档，确认PE/PB字段来源
- [ ] 测试daily_basic API调用
- [ ] 确认字段映射关系

### 阶段2: 数据修复 (3-5天)
- [ ] 编写数据修复脚本
- [ ] 批量调用daily_basic API
- [ ] 更新数据库PE/PB字段
- [ ] 验证数据正确性

### 阶段3: 功能测试 (2天)
- [ ] 测试估值分析功能
- [ ] 验证筛选功能
- [ ] 检查数据展示

## 🔧 技术实施

### 1. API调用测试
```python
# 测试daily_basic API
import tushare as ts
pro = ts.pro_api()

# 获取指定日期的PE/PB数据
df = pro.daily_basic(
    trade_date='20241124',
    fields='ts_code,trade_date,pe,pb,pe_ttm,ps,ps_ttm'
)
print(df.head())
```

### 2. 数据修复脚本
```python
def fix_pe_pb_data():
    """修复PE/PB数据"""
    
    # 获取需要修复的交易日期
    trade_dates = get_missing_pe_pb_dates()
    
    for trade_date in trade_dates:
        # 调用daily_basic API
        df = pro.daily_basic(
            trade_date=trade_date,
            fields='ts_code,trade_date,pe,pb,pe_ttm,ps,ps_ttm'
        )
        
        # 更新数据库
        update_pe_pb_data(df, trade_date)
```

### 3. 数据验证
```python
def validate_pe_pb_data():
    """验证PE/PB数据质量"""
    
    # 检查空值率
    null_rate = check_null_rate(['pe', 'pb'])
    
    # 检查数据合理性
    check_data_range(['pe', 'pb'])
    
    # 生成质量报告
    generate_quality_report()
```

## ⚠️ 风险评估

### API风险
- **调用频率限制**: 大量API调用可能触发限制
- **积分消耗**: 重新获取数据需要消耗积分
- **网络稳定性**: 长时间API调用的稳定性

### 数据风险
- **数据一致性**: 新旧数据可能存在时间差
- **数据准确性**: 需要验证API返回数据的准确性

### 技术风险
- **性能影响**: 大量数据更新可能影响系统性能
- **并发问题**: 数据更新期间的并发访问

## 📈 预期收益

### 功能完善
- 恢复PE/PB估值分析功能
- 支持基于估值的股票筛选
- 提供完整的基本面数据

### 用户体验
- 消除数据显示空白
- 提升分析报告质量
- 增强系统可用性

## 📅 时间计划

- **Day 1**: 问题分析和方案设计
- **Day 2-3**: 编写修复脚本
- **Day 4-6**: 执行数据修复
- **Day 7**: 测试验证和优化

## 🔄 后续优化

### 数据监控
- 建立PE/PB数据质量监控
- 定期检查数据完整性
- 自动化数据修复流程

### 增量更新
- 优化daily_basic数据获取流程
- 确保新数据包含完整字段
- 建立数据质量检查机制

## 👥 责任分工

- **问题分析**: 数据团队
- **脚本开发**: 开发团队
- **数据修复**: 运维团队
- **质量验证**: 测试团队

---

**创建时间**: 2024年12月  
**最后更新**: 2024年12月  
**关联问题**: [数据库字段覆盖问题](数据库字段覆盖问题.md)